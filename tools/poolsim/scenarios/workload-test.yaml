# Workload Simulation Test
#
# Tests reservoir behavior under simulated database workload.
# This models Temporal services making database queries.
#
# Scenario:
# - Services start and fill reservoirs
# - Workload starts after initial fill
# - Each service maintains ~30 concurrent queries
# - Queries hold connections for 10-20ms

seed: 42
endpoint: cluster.dsql.eu-west-1.on.aws

duration: 5m
sampleEvery: 1s

limiterPerSec: 100

assertMaxConnectsPerSec: 100
assertConvergeWithin: 10s
assertStableFor: 5s
assertZeroEmptyEvents: true

scenario:
  kind: cold_start

services:
  - name: history
    targetReady: 50
    guardWindow: 45s
    baseLifetime: 11m
    jitter: 2m
    startDelay: 0s
    workload:
      enabled: true
      maxInUse: 30          # Target 30 concurrent queries
      holdTime: 10ms        # Each query takes 10-20ms
      holdJitter: 10ms
      spawnEvery: 100ms     # Check every 100ms
      arrivalBurst: 10      # Start up to 10 queries per tick
      maxWait: 5s

  - name: matching
    targetReady: 50
    guardWindow: 45s
    baseLifetime: 11m
    jitter: 2m
    startDelay: 100ms
    workload:
      enabled: true
      maxInUse: 20
      holdTime: 5ms
      holdJitter: 5ms
      spawnEvery: 100ms
      arrivalBurst: 10
      maxWait: 5s

  - name: frontend
    targetReady: 50
    guardWindow: 45s
    baseLifetime: 11m
    jitter: 2m
    startDelay: 200ms
    workload:
      enabled: true
      maxInUse: 15
      holdTime: 5ms
      holdJitter: 5ms
      spawnEvery: 100ms
      arrivalBurst: 10
      maxWait: 5s

  - name: worker
    targetReady: 50
    guardWindow: 45s
    baseLifetime: 11m
    jitter: 2m
    startDelay: 300ms
    workload:
      enabled: true
      maxInUse: 10
      holdTime: 20ms
      holdJitter: 10ms
      spawnEvery: 100ms
      arrivalBurst: 5
      maxWait: 5s
